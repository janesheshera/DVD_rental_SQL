<h3> Проектная работа по модулю "SQL и получение данных" (учебный курс Нетологии) </h3>
В работе использовалась демонстрационная база данных, содержащая информацию по магазину проката DVD-дисков :cd:<br>
<br>
<img src="https://user-images.githubusercontent.com/63310859/185807045-309e0a92-544b-4507-8318-dd31c930f0ca.jpg" height="200"/>
Подключение к БД осуществлялось через облако, где развернута база данных. Поставленные задачи решались посредством системы управления базами данных PostgreSQL. Используемое программное приложение DBeaver.<br>
<br>
Для наглядности ER-диаграмма представлена ниже:<br>
<br>
<img src="https://user-images.githubusercontent.com/63310859/185806836-3ff2bcb9-1354-4e48-8348-e53cc89b6faa.jpg" height="500"/>
<br>
В проектной работе осуществленные запросы разбиты на блоки (ссылки на файлы .sql).<br>
<h5>В БЛОКЕ 1 использованы операторы:<br>
- select - выборки из БД по названиям столбцов<br>
- оператор as - перименование столбцов<br>
- distinct - выбор уникальных значений<br>
- фильтрация числовых, текстовых значений и дат - операторы where, limit, like/not like, between и др.<br>
- order by - сортировка <br>
- преобразование текстовых значений - операторы upper, lower, split_part, left, right <br></h5>
<details>
<summary><a href="https://github.com/janesheshera/DVD_rental_SQL/blob/main/1_block_rental.sql"> Блок :one:</a></summary>
1. Вывести уникальные названия городов из таблицы городов.<br>
2. Вывести города, названия которых начинаются на 'L' и заканчиваются на 'a' и не содержат пробелов.<br>
3. Получить из таблицы платежей за прокат фильмов информацию по платежам, которые выполнялись в промежуток с 17 марта 2007 года по 19 марта 2007 года включительно, а также стоимость которых превышает 1.00. Платежи нужно отсортировать по дате.<br>
4. Вывести информацию о 10-ти последних платежах за прокат фильмов.<br>
5. Вывести следующую информацию по покупателям:<br>
  - Фамилия и имя (в одной колонке через пробел)<br>
  - Электронная почта<br>
  - Длину значения поля email<br>
  - Дату последнего обновления записи о покупателе (без времени)<br>
  - Каждой колонке задайте наименование на русском языке <br>
6. Вывести одним запросом только активных покупателей, имена которых Kelly или Willie. Все буквы в фамилии и имени перевести в верхний регистр. <br>
7. Вывести одним запросом информацию о фильмах, у которых рейтинг 'R' и стоимость аренды указана от 0.00 до 3.00 включительно, а также фильмы c рейтингом 'PG-13' и стоимостью аренды больше или равной 4.00.<br>
8. Получить информацию о трёх фильмах с самым длинным описанием.<br>
9. Вывести Email каждого покупателя, разделив значение Email на 2 отдельных колонки: <br>
  - в первой колонке должно быть значение, указанное до @, <br>
  - во второй колонке должно быть значение, указанное после @. <br>
10. Cкорректировать значения в новых колонках: первая буква должна быть заглавной, остальные строчными.<br>
</details>
<h5>В БЛОКЕ 2 использованы операторы:<br>
- join (с using) - соединение таблиц <br>
- агрегирующие функции - count, sum, max, min, avg <br>
- фильтрация для агрегирующих функций - оператор having <br>
- применено декартово произведение <br>
- создан столбец с помощью условного выражения case</h5>
<details>
<summary><a href="https://github.com/janesheshera/DVD_rental_SQL/blob/main/2_block_rental.sql"> Блок :two:</a></summary>
1. Вывести для каждого покупателя его адрес, город и страну проживания. <br>
2. Посчитать для каждого магазина количество покупателей. Доработать запрос и вывести только те магазины, у которых количество покупателей больше 300. Добавить в запрос информацию о городе магазина, фамилии и имени продавца, который работает в нём. <br>
3. Вывести топ 5 покупателей, которые взяли в аренду за всё время наибольшее количество фильмов. <br>
4. Посчитать для каждого покупателя 4 аналитических показателя: <br>
- количество взятых в аренду фильмов <br>
- общую стоимость платежей за аренду всех фильмов (значение округлите до целого числа) <br>
- минимальное значение платежа за аренду фильма <br>
- максимальное значение платежа за аренду фильма <br>
5. Используя данные из таблицы городов, составить одним запросом все возможные пары городов так, чтобы в результате не было пар с одинаковыми названиями городов (использовано декартово произведение). <br>
6. Используя данные из таблицы rental о дате выдачи фильма в аренду (поле rental_date) и дате возврата (поле return_date), вычислить для каждого покупателя среднее количество дней, за которые он возвращает фильмы. <br>
7. Посчитать для каждого фильма, сколько раз его брали в аренду, а также общую стоимость аренды фильма за всё время. <br>
8. Доработать запрос из предыдущего задания и вывести с помощью него фильмы, которые ни разу не брали в аренду. <br>
9. Посчитать количество продаж, выполненных каждым продавцом. Добавить вычисляемую колонку «Премия». Если количество продаж превышает 7 300, то значение в колонке будет «Да», иначе должно быть значение «Нет». <br>
</details>
<h5>В БЛОКЕ 3 спроектирована база данных с помощью операторов:<br>
- create table - создание таблицы <br>
- insert into - добавление значений в таблицу по наименованию столбцов <br>
- update ... set - обновление значений <br>
- drop table - удаление таблицы <br>
- delete from - удаление строк <br>
- unnest(array['']), values () - добавление массива(перечня) значений <br>
- присвоение типа данных и ограничений по столбцам таблицы <br></h5>
<details>
  <summary><a href="https://github.com/janesheshera/DVD_rental_SQL/blob/main/3_block_rental%20(table).sql"> Блок :three: </a></summary>
1. Спроектируйте базу данных для следующих сущностей: <br>
- язык (например: английский, французский и т.д.) <br>
- народность (например: славяне, англосаксы и т.д.) <br>
- страны (например: Россия, Германия и т.д.) <br>
Всего 5 таблиц: 3 таблицы-справочника и 2 таблицы со связями.<br>
Требования к таблицам-справочникам: <br>
- наличие ограничений для первичных ключей <br>
- идентификатору сущности значения должны присваиваться автоинкрементом <br>
- наименования сущностей не должны содержать null-значения, не должны допускаться дубликаты в названиях сущностей <br>
Требования к таблицам со связями: <br>
- наличие ограничений первичных и внешних ключей <br>
<br>
2. Дополнительная часть: <br>
1) Создать новую таблицу film_new со следующими полями:<br>
- film_name — название фильма — тип данных varchar(255) и ограничение not null<br>
- film_year — год выпуска фильма — тип данных integer, условие, что значение должно быть больше 0<br>
- film_rental_rate — стоимость аренды фильма — тип данных numeric(4,2), значение по умолчанию 0.99<br>
- film_duration — длительность фильма в минутах — тип данных integer, ограничение not null и условие, что значение должно быть больше 0<br>
2) Заполнить таблицу film_new данными с помощью SQL-запроса, где колонкам соответствуют массивы данных:<br>
- film_name — array[The Shawshank Redemption, The Green Mile, Back to the Future, Forrest Gump, Schindler’s List]<br>
- film_year — array[1994, 1999, 1985, 1994, 1993]<br>
- film_rental_rate — array[2.99, 0.99, 1.99, 2.99, 3.99]<br>
- film_duration — array[142, 189, 116, 142, 195]<br>
3) Обновить стоимость аренды фильмов в таблице film_new с учётом информации, что стоимость аренды всех фильмов поднялась на 1.41.<br>
4) Фильм с названием Back to the Future был снят с аренды, удалить строку с этим фильмом из таблицы film_new.<br>
5) Добавить в таблицу film_new запись о любом другом новом фильме.<br>
6) SQL-запрос, который выведет все колонки из таблицы film_new, а также новую вычисляемую колонку «длительность фильма в часах» (hour_duration), округлённую до десятых.<br>
7) Удалить таблицу film_new.<br>
</details>
<h5>В БЛОКЕ 4 использованы операторы:<br>
- row_number() over() - оконная функция, нумерующая значения по порядку<br>
- sum() over(), max() over(), count() over() - оконные функции, находящие сумму, максимальное значение, количество согласно с заданной группировкой и сортировкой <br>
- dense_rank() over(partition by ... order by ...) - оконная функция ранжирования по определенному значению (для одинаковых значений ранг совпадает) <br>
- lag() over(), lead() over() - оконные функции, выводящие значения со 'сдвигом' по заданному столбцу <br>
- использованы вложенные запросы </h5>
<details>
<summary><a href="https://github.com/janesheshera/DVD_rental_SQL/blob/main/4_block_rental.sql"> Блок :four: </a></summary>
1. С помощью оконных функций добавить вычисляемые колонки согласно условиям:<br>
- Пронумеровать все платежи от 1 до N по дате<br>
- Пронумеровать платежи для каждого покупателя, сортировка платежей должна быть по дате<br>
- Расчет нарастающим итогом суммы всех платежей для каждого покупателя, сортировка должна сперва по дате платежа, а затем по сумме платежа от наименьшей к большей<br>
- Нумерация платежей для каждого покупателя по стоимости платежа от наибольших к меньшим так, чтобы платежи с одинаковым значением имели одинаковое значение номера<br>
2. С помощью оконной функции вывести для каждого покупателя стоимость платежа и стоимость платежа из предыдущей строки с сортировкой по дате (для первой строки значение по умолчанию 0.0).<br>
3. С помощью оконной функции определить, на сколько каждый следующий платеж покупателя больше или меньше текущего.<br>
4. С помощью оконной функции для каждого покупателя вывести данные о его последней оплате аренды.<br>
5. С помощью оконной функции вывести для каждого сотрудника сумму продаж за апрель 2007 года:<br>
- с нарастающим итогом по каждому сотруднику и по каждой дате продажи (без учёта времени) <br>
- с сортировкой customer_id, payment_date, amount <br>
6. 20 августа 2005 года в магазинах проходила акция: покупатель каждого сотого платежа получал дополнительную скидку на следующую аренду. С помощью оконной функции вывести всех покупателей, которые в день проведения акции получили скидку.<br>
7. Для каждой страны определить и вывести одним SQL-запросом покупателей, которые попадают под условия: <br>
- покупатель, арендовавший наибольшее количество фильмов <br>
- покупатель, который последним арендовал фильм <br>
- покупатель, арендовавший фильмов на самую большую сумму <br>
- покупатель, который последним арендовал фильм <br>
</details>
<h5>В БЛОКЕ 5 использованы операторы:<br>
- выборки из колонок с типом данных 'массив'(array) с помощью операторов: &&, @>, <@, array_agg(unnest). <br>
- create materialized view - создание материализованного представления <br>
- refresh materialized view - обновление материлизованного представления <br>
- создано материализованное представление без наполнения (with no data) <br>
- with ... as() - создание и использование общих табличных выражений (CTE) <br>
- рассчитаны экономические показатели работы магазина <br>
</h5>
<details>
  <summary><a href="https://github.com/janesheshera/DVD_rental_SQL/blob/main/5_block_rental.sql"> Блок :five: </a></summary>
1. Вывести всю информацию о фильмах со специальным атрибутом "Behind the Scenes".<br>
2. Написать еще 2 варианта поиска фильмов с атрибутом "Behind the Scenes", используя другие функции или операторы языка SQL для поиска значения в массиве.<br>
3. Для каждого покупателя посчитать сколько он брал в аренду фильмов со специальным атрибутом "Behind the Scenes. Условие: использовать запрос из задания 1, помещенный в CTE. <br>
4. Для каждого покупателя посчитать сколько он брал в аренду фильмов со специальным атрибутом "Behind the Scenes". Условие: использовать запрос из задания 1, помещенный в подзапрос. <br>
5. Вывеcти сколько раз встречается специальный атрибут (special_features) у фильма. <br>
6. Вывеcти сколько элементов содержит атрибут special_features. <br>
7. Вывести все фильмы содержащие специальные атрибуты: 'Trailers','Commentaries'. <br>
8. Создать материализованное представление с запросом из предыдущего задания и написать запрос для обновления материализованного представления.<br>
9. Создать материализованное представление без наполнения (with NO DATA) с колонками клиент (ФИО; email) и title фильма, который он брал в прокат последним. <br>
10. Используя оконную функцию вывести для каждого сотрудника сведения о самой первой продаже этого сотрудника. <br>
11. Для каждого магазина определить и вывести одним SQL-запросом следующие аналитические показатели: <br>
· день, в который арендовали больше всего фильмов (день в формате год-месяц-день)<br>
· количество фильмов взятых в аренду в этот день<br>
· день, в который продали фильмов на наименьшую сумму (день в формате год-месяц-день);<br>
· сумму продажи в этот день<br>
</details>

<h5>В БЛОКЕ 6 рассчитаны следующие описательные экономические показатели: <br>
- совокупный доход всех магазинов на каждую дату <br>
- наиболее и наименее востребованные жанры <br>
- средняя арендная ставка для каждого жанра фильмов <br>
- 5 самых дорогих клиентов <br>
- своевременность возврата арендованных фильмов <br>
</h5>
<details>
<summary><a href="https://github.com/janesheshera/DVD_rental_SQL/blob/main/6_block_rental.sql"> Блок :six: </a></summary>
1. Рассчитать совокупный доход всех магазинов на каждую дату <br>
2. Вывести наиболее и наименее востребованные жанры <br>
3. Рассчитать среднюю арендную ставку для каждого жанра <br>
4. Составить список из 5 самых дорогих клиентов <br>
5. Статистика своевременности возврата арендованных фильмов <br>
</details>

<h6>*все ссылки открываются в текущем окне</h6>
